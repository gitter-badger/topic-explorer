<!DOCTYPE html>
<html>
<head>
<title>InPhO Topic Explorer</title>
<script src="lib/jquery-1.11.0.min.js"></script>
<script src="lib/jquery.superdom.min.js"></script>
<script src="lib/bootstrap-2.3.2/js/bootstrap.min.js"></script>
<script src="lib/d3.v3.min.js"></script>
<script src="lib/mustache.js"></script>
<script src="lib/inpho/util.js"></script>
<script src="htrc.js"></script>
<!--<script src="sep.js"></script>-->
<link rel="stylesheet" type="text/css" href="lib/bootstrap-2.3.2/css/bootstrap.min.css" />
<!--<link rel="stylesheet" type="text/css" href="style.css" />-->
<style>
.y.axis text {
  visibility: hidden;
}
.y.axis g .sepIcon,
.y.axis g .htrcIcon,
.y.axis g .linkIcon,
.y.axis g .inphoIcon {
  opacity: 0;
  }
.y.axis g:hover .inphoIcon,
.y.axis g:hover .htrcIcon,
.y.axis g:hover .linkIcon,
.y.axis g:hover .sepIcon {
  opacity: 1.0;
  }

.y.axis text, .y.axis image {
  cursor: pointer;
  }
.y.axis rect:hover {
  stroke: #fff;  
  stroke-width: 0;
  opacity: 0 !important;
}
.y.axis rect:hover .sepIcon,
.y.axis rect:hover .htrcIcon,
.y.axis rect:hover .linkIcon,
.y.axis rect:hover .inphoIcon {
  opacity: 1 !important;
}

.docLabel {
  }

.bar {
    fill: steelblue;
}

.bar:hover {
    fill: brown;
}

.axis {
    font: 11px sans-serif;
}

.axis path,
.axis line {
    fill: none;
    stroke: #000;
    shape-rendering: crispEdges;
}
.docLabel{
  font:11px sans-serif;  
  pointer-events: none;
}

rect {
  opacity: 0.6;
  }

rect.hover {
  stroke: #000;
  stroke-width: 1;
  shape-rendering: crispEdges;
  cursor: crosshair;
}

rect.hover, .legend rect {
  opacity: 0.8;
}
.doc:hover rect, .doc.hover rect {
  opacity: 1.0;
  }
rect:hover {
  opacity: 1.0 !important;
}
rect:hover, .legend.hover rect, .legend.selected rect {
  stroke: #000;
  stroke-width: 2;
  shape-rendering: crispEdges;
  }
.docLabel{
  font:11px sans-serif;  
}
.selected text, .hover text {
  font-weight: bold;
}
#legend, #controls {
  position: absolute;
  overflow: visible;
}
.primary {
  text-transform: uppercase;
}
text.hover, .title{ 
  font-weight: bold;
  }
/*
.primary.doc:hover, .primary.doc {
  stroke: #000;
  stroke-width: 1px;
  stroke-opacity: 1.0;
  shape-rendering: crispEdges;
}*/
.logo-word {
  background-image: url('http://inphodata.cogs.indiana.edu/img/inpho_logo.png');
  background-size: 172px 92px;
  width: 172px;
  height: 84px;
  padding-top: 6px;
  margin-top: 14px;
  margin-bottom: 15px;
  margin-left: -6px;
  display: inline-block;
  text-indent: -3000px;
}
h1 {
text-align: center;
margin-bottom: 0;
font-size: 59px;
line-height: 1;
color: inherit;
letter-spacing: -1px;

}
h1 a, h1 a:hover {
  color: #000;
  text-decoration: none;
}

.btn {
  vertical-align: middle;
  margin-top: 2px;
}
#twitter-widget-0 {
  margin-bottom: -11px;
}
.null, .non-null {
  display: none;
  }
.formula {
  font-variant: small-caps;
  }
.formula em {
  font-variant: normal;  
}
</style>
</head>

<body>
<div class="container">
  <div class="row">
  <div class="span12">
  <h1><a href="http://inphodata.cogs.indiana.edu"><span class="logo-word">InPhO</span> Topic Explorer</a></h1>
  <!--<h2 class="title"></h2>-->
  <p class="null">This visualization shows the similarity of volumes in the HTRC-1315 collection, generated by searching the <a href="http://hathitrust.org/">HathiTrust Research Collection</a> in 2013 for the terms "anthropomorphism", "comparative psychology", and "Darwin". This corpus is meant to show how topic modeling can be used to improve corpus curation and is guided by real-world research practice for the history of comparative psychology. Use the search box below to select a volume or click the <span class="icon-random"></span> button to populate the box with a random volume.</p>
  <p class="non-null">This visualization shows the similarity of volumes in the HTRC to <span class="title"></span>.  The color bands within each article's row show the topic distribution within that article, and the relative sizes of each band indicates the weight of that topic in the article. The total width of each row indicates similarity to the focal topic or document, measured by the quantity <span class="formula">sim(<em>doc</em>) = 1 &ndash; JSD(<em>doc</em>, <span class="title"></span>)</span>, where <span class="formula">JSD</span> is the <a href="http://en.wikipedia.org/wiki/Jensenâ€“Shannon_divergence">Jensen-Shannon distance</a> between the word probability distributions of each item. Each topic's label and color is arbitrarily assigned, but is consistent across articles in the browser.</p>
  <p class="non-null">Display options include topic normalization, alphabetical sort and topic sort. By normalizing topics, the combined width of each bar expands so that topic weights per document can be compared. By clicking a topic, the documents will reorder acoording to that topic's weight and topic bars will reorder according to the topic weights in the highest weighted document. When a topic is selected, clicking "Top Documents for [Topic]" will take you to a new page showing the most similar documents to that topic's word distribution. The original sort order can be restored with the "Reset Topic Sort" button.</p>
  <p class="non-null">Clicking the HathiTrust icon that appears when a row is highlighted displays the title of that volume, along with links to the full-text in HathiTrust and catalog records in several linked data repositories.</p>
  <p>The underlying dataset was generated using the <a href="http://github.com/inpho/vsm" target="_blank">InPhO VSM module's</a> LDA implementation.  See <a href="http://en.wikipedia.org/wiki/Latent_Dirichlet_allocation" target="_blank">Wikipedia: Latent Dirichlet Allocation</a> for more on the LDA topic modeling approach or <a href="http://dl.acm.org/citation.cfm?id=2133826" target="_blank">"Probabilistic Topic Models" (Blei, 2012)</a> for a recent review.</p>
  <p><a href="http://github.com/inpho/topic-explorer/" target="_blank">Source code</a> and <a href="http://github.com/inpho/topic-explorer/issues/" target="_blank">issue tracking</a> for this page available at <a href="http://github.com/inpho/topic-explorer/" target="_blank">GitHub</a>. Contact Jaimie Murdock (<span class="iumail">jammurdo</span>) with further comments.</p>
  <script>var mail = $('.iumail').text();
  $('.iumail').html('<a href="mailto:'+mail+'@indiana.edu">'+mail+'@indiana.edu</a>')</script>
  
  <form action="/" method="GET" class="form-inline">
  <div class="input-append">
    <input type="hidden" name="doc" id="hidden_id">
    <input type="text" id="doc" class="typeahead input-xlarge" placeholder="Document" autocomplete="off">
    <button class="btn" type="button" id="randomDoc"><span class="icon-random"></span></button>
  </div>
  <div class="btn-group">
    <button type="submit" id="submit" class="btn">Visualize</button>
    <a class="btn dropdown-toggle" data-toggle="dropdown"><span class="caret"></span></a>
    <ul class="dropdown-menu">
    <li><a href="javascript:visualize(20)">20 Topics</a></li>
    <li><a href="javascript:visualize(40)">40 Topics</a></li>
    <li><a href="javascript:visualize(60)">60 Topics</a></li>
    <li><a href="javascript:visualize(80)">80 Topics</a></li>
    </ul>
  </div>
  <a href="https://twitter.com/share" class="twitter-share-button pull-right" style="padding-top: 10px" data-text="InPhO Topic Explorer" data-via="JaimieMurdock" data-size="large" data-hashtags="dighum" data-counturl="inphodata.cogs.indiana.edu">Tweet</a>
  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
  </form>
  </div>
  </div>
  <div class="non-null" id="status" style="width:100%">
    <div class="progress loading progress-striped active">
      <div class="bar" style="width:25%">Loading documents...</div>
    </div>
  </div>
  
</div>
<script>
var docid = inpho.util.getValueForURLParam('doc') || null;
if (docid) {
  docid = decodeURIComponent(docid);
  docid = docid.toLowerCase();
  $('#hidden_id').val(docid);
  $('.twitter-share-button').attr('data-text', "What's similar to " +docid+"? Discover with the #InPhO Topic Explorer");

}
var roottopic = inpho.util.getValueForURLParam('topic') || null;

if (roottopic) {
  $('.title').html('Topic ' + roottopic);
  $('.twitter-share-button').attr('data-text', "Check out topic "+ roottopic+" at the #InPhO Topic Explorer!");
}

if (docid || roottopic)
  $('.non-null').show()
else
  $('.null').show();

function visualize(k) {
  var url = "http://inphodata.cogs.indiana.edu:17"
  if (k < 100) url += "0" + k;
  else url += k;

  url += "?doc=" + encodeURIComponent($("#hidden_id").val() || docid) ;
  window.location = url;
}

var labels, mapped;
$.getJSON('/docs.json', function(data) {
  $(".typeahead").typeahead({items: 12,
    source: function(query, process) {
      labels = [];
      mapped = {};
      $.each(data, function(i, item) {
        mapped[item.label] = item;
        labels.push(item.label);
      });
        
      process(labels);
      this.$menu.find('.active').removeClass('active');
    },
    updater: function(item) {
      if (!item) return this.$element.val();
      else $('#hidden_id').val(mapped[item].id);
      return item;
    },
    sorter: function(items) {
      var query = this.query;
      items = items.sort();
      var start = items.filter(function(item) { return item.lastIndexOf(query, 0) == 0;});
      var elsewhere = items.filter(function(item) { return item.lastIndexOf(query, 0) != 0;});
      return start.concat(elsewhere);
      }});
  $('#randomDoc').click(function() { 
      var rand = data[Math.floor(Math.random() * data.length)];
      $('#hidden_id').val(rand.id);
      $('#doc').val(rand.label);
    });
  $('#randomDoc').tooltip({title: "Random Document", placement: 'bottom'});

  if (docid) {
    title = data.filter(function(item) { return item.id == docid });
    if (title.length) {
      title = title[0].label;
      $('.title').html('<a href="http://hdl.handle.net/2027/'+docid+'" target="_blank" title="HathiTrust: '+docid+'">'+title+'</a>');
    } else {
      $('.title').html('the volume <a href="http://hdl.handle.net/2027/'+docid+'" target="_blank" title="HathiTrust: '+docid+'">'+docid+'</a>');
    }
  }
});
</script>


<div id="chart"> </div>
<div id="controls" style="display:none;">
  <strong>Display Options</strong>
  <label class="checkbox"><input class="sort" type="checkbox"> Alphabetical sort</label>
  <label class="checkbox"><input class="scale" type="checkbox"> Normalize topic bars</label>
  <button class="btn reset" onclick="resetTopicSort()" disabled>Reset Topic Sort</button><br>
  <button class="btn topdoc" style="display:none">Top Documents for [Topic]</button>
</div>

<!--<script src="topics.js"></script>-->
<script>

var maxRows = 25;
var minCols = 2;


var margin = {top: 80, right: 40, bottom: 20, left: 55},
    width = 960 - margin.left - margin.right,
    height = 600 - margin.top - margin.bottom;

var x = d3.scale.linear()
    .range([0, width]);

var y = d3.scale.ordinal()
    .rangeRoundBands([0, height], .1, 0);

var color = d3.scale.category20c();

var xAxis = d3.svg.axis()
    .scale(x)
    .orient("top")
    .ticks(10, "%");

var yAxis = d3.svg.axis()
    .scale(y)
    .orient("left");

function computeWidth(numCols) { 
  $('#legend').attr("width", margin.right + (numCols*55) + 20 + margin.right);
  $('#main').attr("width", Math.max($(window).width() - $('#legend').width() - 200 + margin.right, 750));
  $('#controls').css("left", Math.max($(window).width() - $('#legend').width() - 200 + margin.right, 750) + 40);
  width = Math.max($(window).width() - $('#legend').width() - 200 + margin.right, 750) - margin.left - margin.right;
  x = d3.scale.linear()
    .range([0, width]);
  x.domain([0,1]);
  xAxis = d3.svg.axis()
    .scale(x)
    .orient("top")
    .ticks(10, "%");
}

function computeHeight(data, numLegendRows) { 
  height = (data.length * 20);// - margin.top - margin.bottom;
  y = d3.scale.ordinal()
   .rangeRoundBands([0, height], .1, 0);
  y.domain(data.map(function(d) { return d.doc; }));
  yAxis = d3.svg.axis()
    .scale(y)
    .orient("left");
}

var dataset;
var original_root;

var svg = d3.select("#chart").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .attr("id","main")
    .attr("class", "main")
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
    .on("mouseleave", function() {
        $(".legend rect").removeClass('hover').tooltip('hide');
      });

var legend = d3.select("#chart").append("svg")
    .attr("width", "350")
    .attr("id", "legend")
    .attr("class", "main")
  .append("g")
    .attr("transform","translate("+margin.right+","+ margin.top + ")");

function calculateTopicMap(data, scale, sortFn){
  data.forEach(function(d) {
    var sizeFactor = (scale) ? d.prob : 1.0
    var x0 = 0;
    if (sortFn) d.topicMap = color.domain()
      .sort(sortFn)
      .map(function(name) { return {name: name, x0: x0, x1: x0 += +(d.topics[name]*sizeFactor) }; });
    else d.topicMap = color.domain()
      .map(function(name) { return {name: name, x0: x0, x1: x0 += +(d.topics[name]*sizeFactor) }; });
  });
  
}

var url;
if (roottopic) url = "/topics/" + roottopic + '.json';
else url = "/docs_topics/" + docid + '.json'

var n = inpho.util.getValueForURLParam('n');
if (n) url += "?n=" + n;

d3.json(url, function(error, data) {
  $('#status .bar').css('width', '50%').text('Loading topics...');
  if (error) {
    $('#status .progress').removeClass('active progress-striped');
    var errormsg;
    
    if (roottopic) errormsg = "Invalid topic: " + roottopic + ".";
    else errormsg = "Invalid document: " + docid + ".";

    $('#status .bar').addClass('bar-danger').text(errormsg);
    return false;
  }
  console.log(data);
  d3.json("/topics.json", function(error_top, topics) {
  $('#status .bar').css('width', '75%').text('Rendering chart...');
  if (error_top) {
    $('#status .progress').removeClass('active progress-striped');
    $('#status .bar-danger').addClass('bar-error').text('Could not load topic list.');
    return false;
  }
    console.log(topics);
  $('#submit').text(d3.keys(topics).length + ' Topics');
  

  var legendCols = Math.max(Math.ceil(d3.keys(topics).length / Math.min(data.length, maxRows)), minCols);
  var legendFactor = Math.ceil(d3.keys(topics).length / legendCols);
  computeHeight(data,legendFactor);
  $("#main").attr("height", height + margin.top + margin.bottom);
  $("#legend").attr("height", (legendFactor * 20) + margin.top + margin.bottom);
  computeWidth(legendCols);


  x.domain([0, 1.0]);
  tops = data;
  color.domain(d3.keys(data[0].topics));
    //.sort();

  calculateTopicMap(data, true, function(a,b) {return data[0].topics[b] - data[0].topics[a];});


  dataset = data;
  original_root = data[0];
  if (roottopic) docid = data[0]['doc'];

  svg.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(10,-10)")
      .call(xAxis)
    .append("text")
      //.attr("transform", "rotate(-120)")
      .attr("class", "axis_label")
      .attr("dy", "-2em")
      .style("text-anchor", "start")
      .text("Similarity to " + (roottopic ? ("Topic " + roottopic) : '"'+original_root['label']+'"'));

  svg.append("g")
      .attr("class", "y axis")
      .call(yAxis)
      .selectAll("text")
      .attr("class", function(d) { return (d == docid && roottopic == null) ? "primary" : "" })
      .on("click", function(d) { window.location.href = "/?doc=" + encodeURIComponent(d);});

  svg.select(".y.axis").selectAll("g")
      .insert("rect", ":first-child")
        .attr("x", -margin.left + 5)
        .attr("y", -9)
        .attr("width", margin.left-5)
        .attr("height", 18)
        .style("opacity", "0");

  var ticks = svg.select(".y.axis").selectAll("g")
      .on("mouseenter", function(d) { 
        $('text', this).attr('text-decoration', 'underline')
          .attr('font-weight', 'bold');     
        svg.selectAll(".doc")
          .filter(function(doc,i) { return doc.doc == d})
          .attr("class", function(d) { return (d.doc == docid ? "doc primary" : "doc") + " hover"}); 
        })
      .on("mouseleave", function(d) { 
        $('text',this).removeAttr('text-decoration')
          .removeAttr('font-weight'); 
        svg.selectAll(".doc")
          .filter(function(doc,i) { return doc.doc == d})
          .attr("class", function(d) { return d.doc == docid ? "doc primary" : "doc"}); 
        });
    ticks.append("svg:image")
        .attr("xlink:href","/img/htrc.png")
        .attr("width", 18)
        .attr("height",18)
        .attr("x", -margin.left + 5)
        .attr("y", -9)
        //.attr("x", -9)
        .attr("class", "htrcIcon")
        .attr("data-htrc-id", function(d) { return d; })
        .attr("onclick", function(d) { return (d) ? "htrc.popover(this)" : ""; });
    ticks.append("svg:image")
        .attr("xlink:href","/img/link.png")
        .attr("width", 18)
        .attr("height",18)
        .attr("x", -margin.left + 5 + 20)
        .attr("y", -9)
        //.attr("x", -9)
        .attr("class", "linkIcon")
        .on("click", function(d) { window.location.href = "/?doc=" + encodeURIComponent(d);});

  // draw total bar
  var doc = svg.selectAll("doc")
      .data(data)
    .enter().append("g")
      .attr("class", function(d) { return d.doc == docid ? "doc primary" : "doc"})
      .attr("transform", function(d) { return "translate(10," + y(d.doc) + ")"; })
      .on("mouseover", function(d) {
          $("text:contains(" + d.doc +")")
            .filter(function() {return $(this).text().trim() == d.doc })
            .attr("font-weight", "bold")
            .next(".htrcIcon").css('opacity', '1.0')
            .next(".linkIcon").css('opacity', '1.0');
        })
      .on("mouseout", function(d) {
          $("text:contains(" + d.doc +")")
            .filter(function() {return $(this).text().trim() == d.doc })
            .attr("font-weight", "normal")
            .next(".htrcIcon").css('opacity', '')
            .next(".linkIcon").css('opacity', '');
        });

  // Draw topic bars
  doc.selectAll("rect")
      .data(function(d) { return d.topicMap; })
    .enter().append("rect")
      .attr("height", y.rangeBand())
      .attr("x", function(d) { return x(d.x0); })
      .attr("width", function(d) { return x(d.x1) - x(d.x0); })
      .attr("class", function(d) { return "top_" + d.name; })
      .on("mouseover", function(d) {
          // SVG element z-index determined by render order, not style sheet
          // so element must be reappended to the end on hover so border 
          // is not occluded
          var parent = $(this).parent();
          $(this).detach().appendTo(parent);
          $(".docLabel", parent).detach().appendTo(parent);
          $(".docLabel", parent).addClass("hover");
          $('.legend rect').not('.top_' + d.name).tooltip('hide');
          $(".top_" + d.name).addClass('hover');
          $('.legend rect.top_' + d.name).tooltip('show');
        })
      .on("mouseout", function(d) {
          var parent = $(this).parent();
          $(".docLabel", parent).removeClass("hover");
          $(".top_" + d.name).removeClass('hover');
        })
      .on("click", function(d) { topicSort(d.name); })
      .style("fill", function(d) { return color(d.name); });
  
  doc.append("text")
        .text(function(d) { return d.label; })
        .attr("class","docLabel")
        .attr("dx", "3")
        .attr("dy", "13");

  var legendElts = legend.selectAll(".legend")
      .data(color.domain().slice())
      //.data(d3.keys(data[0].topics))
    .enter().append("g")
      .attr("class", function(d) { return "legend top_" + d; })
      .attr("transform", function(d, i) { return "translate("+(55 * Math.floor(i / legendFactor))+"," + y(i % legendFactor) + ")"; });

  legendElts.append("rect")
      .attr("width", 18)
      .attr("height", 18)
      .attr("class", function(d) { return "top_" + d; })
      .style("fill", color)
      //.attr("data-toggle", "tooltip")
      .attr("data-placement", "right")
      .attr("title", function(d) { return d3.keys(topics[d]).join(", ") + ", ..."; })
      .on("click", function(d) { topicSort(d); })
      .on("mouseover", function(d) {
          $(".top_" + d).addClass('hover').tooltip('show');
        })
      .on("mouseout", function(d) {
          $(".top_" + d).removeClass('hover').tooltip('hide');
        });

  $(".legend rect").tooltip({container:'body', trigger: 'manual', animation: false});

  legendElts.append("text")
      .attr("dx", -6)
      .attr("y", 9)
      .attr("dy", ".35em")
      .style("text-anchor", "end")
      .text(function(d) { return d; });


  legend.append("text")
      .attr("dx", -6)
      .attr("dy", "-.35em")
      .attr("font-weight", "bold")
      .style("text-anchor", "end")
      .text(d3.keys(topics).length);
  legend.append("text")
      //.attr("transform", "rotate(-120)")
      .attr("class", "axis_label")
      .attr("dy", "-.35em")
      .attr("font-weight", "bold")
      .style("text-anchor", "start")
      .text("Topics");
  legend.append("text")
      //.attr("transform", "rotate(-120)")
      .attr("class", "axis_label")
      .attr("dy", "-.45em")
      .attr("dx", "5em")
      .attr("font-size", "10px")
      .style("text-anchor", "start")
      .text("ordered by P( T | " + docid + " )");

  d3.select(window).on('resize', resize);

  function resize() {
    computeWidth(legendCols);

    /* Update the axis with the new scale */
    svg.select('.x.axis')
      .call(xAxis);

    doc.selectAll('rect')
      .attr("x", function(d) { return x(d.x0); })
      .attr("width", function(d) { return x(d.x1) - x(d.x0); });
  }



  d3.select(".sort").on("change", alphabetSort);
  
  $('#status .bar').addClass('bar-success').css('width', '100%').text("Complete!");
  setTimeout(function() { 
    $('#status').hide(500);
    setTimeout(function() {$('#controls').css({'top' : $('#legend').height() + $('#legend').position().top}).show();}, 500);
    } , 500);

  $(window).on("scroll", scrollLegend);
  function scrollLegend() {
    var scrollPos = $(window).scrollTop();
    var chartHeight = $('#chart').position().top;
    var legendHeight = $('#legend').height();
    var heightFac = -60;
    if((scrollPos - chartHeight - margin.top - heightFac) <= 0) {
      $('#legend').css({'position': 'absolute', 'top' : chartHeight});
      $('#controls').css({'position': 'absolute', 'top' : legendHeight + chartHeight});
    } else if ((scrollPos - chartHeight - heightFac) < (margin.top)) {
      $('#legend').css({'position': 'absolute', 'top' : scrollPos + heightFac});
      $('#controls').css({'position': 'absolute', 'top' : legendHeight+ scrollPos + heightFac});
    } else {
      $('#legend').css({'position': 'fixed', 'top' : heightFac});
      $('#controls').css({'position': 'fixed', 'top' : legendHeight + heightFac});
    }}
   
  $('.htrcIcon').tooltip({placement: 'top', title: 'Click for the HathiTrust Details.', container: 'body', html: true, animation: false});
  $('.linkIcon').tooltip({placement: 'top', title: 'Click to refocus the Topic Explorer on this document.', container: 'body', html: true, animation: false});
}); });

  function scaleTopics() {
    var numTopics = dataset[0].topics.length;
    var delay = function(d, i) { return i * (500/numTopics); },
        negdelay = function(d, i) { return (numTopics-i) * (500/numTopics); };

    calculateTopicMap(dataset, !this.checked);

    $(".doc").each(function(i,elt) {
        $(elt).children()
          .sort(function(a,b) { return $(a).attr('x') - $(b).attr('x'); })
          .each(function(j,child) {
            $(child).detach().appendTo($(elt));
        })
      });

    svg.selectAll(".doc")
      .selectAll("rect")
      .data(function(d) { return d.topicMap; })
      .style("fill", function(d) { return color(d.name); })
      /*.on("mouseover", function(d) {
          // SVG element z-index determined by render order, not style sheet
          // so element must be reappended to the end on hover so border 
          // is not occluded
          var parent = $(this).parent();
          $(this).detach().appendTo(parent);
          $(".docLabel", parent).detach().appendTo(parent);
          $('.legend rect').not('.top_' + d.name).tooltip('hide');
          $(".top_" + d.name).addClass('hover');
          $('.legend rect.top_' + d.name).tooltip('show');
        })
      .on("mouseout", function(d) {
          $(".top_" + d.name).removeClass('hover');
        })*/
      .transition().duration(500).ease("linear").delay(this.checked ? delay : negdelay)
      .attr("x", function(d) { return x(d.x0); })
      .attr("width", function(d) { return x(d.x1) - x(d.x0); })
      .attr("class", function(d) { return "top_" + d.name; });

    svg.selectAll(".x.axis text.axis_label").text(this.checked ? 
      "Proportion of document assigned to topic" : 
      ("Similarity to " + (roottopic ? ("Topic " + roottopic) : '"'+original_root.label+'"')));
  }

  d3.select(".scale").on("change", scaleTopics);
  function sortDataset(sortFn) {
    dataset = dataset.sort(sortFn);

    var y0 = y.domain(dataset
        .map(function(d) { return d.doc; }))
        .copy();

    var transition = svg.transition().duration(500),
        delay = function(d, i) { return i * 25; };

    transition.selectAll(".doc")
        .delay(delay)
        .attr("transform", function(d) { return "translate(10," + y(d.doc) + ")"; });
        //.attr("y", function(d) { return y(d.doc); });

    transition.select(".y.axis")
        .call(yAxis)
      .selectAll("g")
        .selectAll("text")
        .delay(delay);
  }

  function alphabetSort() {
    // Copy-on-write since tweens are evaluated after a delay.
    if (this.checked)
      sortDataset(function(a, b) { return d3.ascending(a.doc, b.doc); });
    else
      sortDataset(function(a, b) { return b.prob - a.prob; });
  }

  function resetTopicSort() {
    $('.reset').attr('disabled',true);
    $('.topicsort').attr('disabled',true);
    $('.selected').removeClass('selected');
    $('.topdoc').hide();
    $('.topdoc').text('Top Documents for [Topic]');
    if (!($('.sort')[0].checked))
      sortDataset(function(a,b) { return b.prob - a.prob; });

    redrawBars(function(a,b) { return original_root.topics[b] - original_root.topics[a]; });
  }

  function topicSort(topic) {
    // Copy-on-write since tweens are evaluated after a delay.
    $('.sort').removeAttr('checked');
    if (topic) {
      sortDataset(function(a, b) { return b.topics[topic] - a.topics[topic]; });
      $(".top_" + topic).addClass('selected');
      $('.reset').removeAttr('disabled');
      $('.topdoc').text('Top Documents for Topic ' + topic);
      $('.topdoc').show();
      $('.topdoc').click(function URL() {location.href = location.origin + '?topic=' + topic;});
      $('.topdoc').mouseenter(function() {
          $('.legend rect').not('.top_' + topic).tooltip('hide');
          $(".legend rect.top_" + topic).tooltip('show'); });
      $('.topdoc').mouseleave(function() { $(".top_" + topic).tooltip('hide'); });

    } else {
      $('.selected').removeClass('selected');
      sortDataset(function(a, b) { return b.prob - a.prob; });
    }


    var sortFn = function(a,b) {
      if (a == topic) return -1;
      else if (b == topic) return 1;
      else return dataset[0].topics[b] - dataset[0].topics[a];
      //else return original_root.topics[b] - original_root.topics[a];
    } 
    redrawBars(sortFn);
  }

  function redrawBars(sortFn) { 
    $("#legend .hover").removeClass("hover");
    var numTopics = dataset[0].topics.length;
    var delay = function(d, i) { return i * (1000/numTopics); },
        negdelay = function(d, i) { return (numTopics-i) * (1000/numTopics); };
    calculateTopicMap(dataset, !($('.scale')[0].checked), sortFn);
    
    svg.selectAll(".doc")
      .selectAll("rect")
      .data(function(d) { return d.topicMap; })
      .style("fill", function(d) { return color(d.name); })
      /*
      .on("mouseover", function(d) {
          // SVG element z-index determined by render order, not style sheet
          // so element must be reappended to the end on hover so border 
          // is not occluded
          var parent = $(this).parent();
          $(this).detach().appendTo(parent);
          $(".docLabel", parent).detach().appendTo(parent);
          $('.legend rect').not('.top_' + d.name).tooltip('hide');
          $(".top_" + d.name).addClass('hover');
          $('.legend rect.top_' + d.name).tooltip('show');
        })
      .on("mouseout", function(d) {
          $(".top_" + d.name).removeClass('hover');
        })*/
      .transition().duration(1000).ease("linear").delay(this.checked ? delay : negdelay)
      .attr("x", function(d) { return x(d.x0); })
      .attr("width", function(d) { return x(d.x1) - x(d.x0); })
      .attr("class", function(d) { return "top_" + d.name; });

  }


</script>

</body>
</html>
