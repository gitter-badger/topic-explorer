<!DOCTYPE html>
<html>
<head>
<title>InPhO Topic Explorer</title>
<script src="lib/jquery-1.11.0.min.js"></script>
<script src="lib/jquery.superdom.min.js"></script>
<script src="lib/bootstrap-2.3.2/js/bootstrap.min.js"></script>
<script src="lib/d3.v3.min.js"></script>
<script src="lib/mustache.js"></script>
<script src="lib/inpho/util.js"></script>
<!--<script src="sep.js"></script>-->
<link rel="stylesheet" type="text/css" href="lib/bootstrap-2.3.2/css/bootstrap.min.css" />
<!--<link rel="stylesheet" type="text/css" href="style.css" />-->
<style>
body {
  margin-top: 150px;
  }
.bar {
    fill: steelblue;
}
.bar:hover {
    fill: brown;
}
rect {
  opacity: 0.6;
}
rect.hover {
  stroke: #000;
  stroke-width: 1;
  shape-rendering: crispEdges;
  cursor: crosshair;
  opacity: 0.8;
}
.doc:hover rect, .doc.hover rect {
  cursor: crosshair;
  opacity: 1.0;
}
rect:hover {
  opacity: 1.0 !important;
  stroke: #000;
  stroke-width: 2;
  shape-rendering: crispEdges;
}
</style>
</head>

<body>
<div class="container">
  <div id="status" style="width:100%">
    <div class="progress loading progress-striped active">
      <div class="bar" style="width:25%">Loading documents...</div>
    </div>
  </div>
<div id="chart"> </div>
  
</div>

<script>
var maxRows = 25;
var minCols = 2;

//${c.enity.sep_dir}
var docid = inpho.util.getValueForURLParam('doc') || null;

var width = $('.container').width(),
    height = 20;

var x = d3.scale.linear()
    .range([0, width])
    .domain([0,1.0]);

var color = d3.scale.category20c();

var svg = d3.select("#chart").append("svg")
    .attr("width", width)
    .attr("height", height)
    .attr("id","main")
    .attr("class", "main");
$('#main').hide();

function calculateTopicMap(data, scale, sortFn){
  data.forEach(function(d) {
    var sizeFactor = (scale) ? d.prob : 1.0
    var x0 = 0;
    if (sortFn) d.topicMap = color.domain()
      .sort(sortFn)
      .map(function(name) { return {name: name, x0: x0, x1: x0 += +(d.topics[name]*sizeFactor) }; });
    else d.topicMap = color.domain()
      .map(function(name) { return {name: name, x0: x0, x1: x0 += +(d.topics[name]*sizeFactor) }; });
  });
  
}

var url = "/docs_topics/" + docid + '.json?n=1'

d3.json(url, function(error, data) {
  $('#status .bar').css('width', '50%').text('Loading topics...');
  if (error) {
    $('#status .progress').removeClass('active progress-striped');
    var errormsg;
    
    if (roottopic) errormsg = "Invalid topic: " + roottopic + ".";
    else errormsg = "Invalid document: " + docid + ".";

    $('#status .bar').addClass('bar-danger').text(errormsg);
    return false;
  }
  console.log(data);
  d3.json("/topics.json", function(error_top, topics) {
    $('#status .bar').css('width', '75%').text('Rendering chart...');
    if (error_top) {
      $('#status .progress').removeClass('active progress-striped');
      $('#status .bar-danger').addClass('bar-error').text('Could not load topic list.');
      return false;
    }

    var k = d3.keys(topics).length;
    var full_explorer_url = (k < 100) ?
      "http://inphodata.cogs.indiana.edu:160"+k+"/?doc="+docid :
      "http://inphodata.cogs.indiana.edu:16"+k+"/?doc="+docid;
  
    color.domain(d3.keys(data[0].topics));
  
    calculateTopicMap(data, true, function(a,b) {return data[0].topics[b] - data[0].topics[a];});
  
    // draw total bar
    var doc = svg.selectAll("doc")
        .data(data)
      .enter().append("g")
        .attr("class","doc");
  
    // Draw topic bars
    doc.selectAll("rect")
        .data(function(d) { return d.topicMap; })
      .enter().append("rect")
        .attr("height", height)
        .attr("x", function(d) { return x(d.x0); })
        .attr("width", function(d) { return x(d.x1) - x(d.x0); })
        .attr("class", function(d) { return "top_" + d.name; })
        .attr("title", function(d) { return d3.keys(topics[d.name]).join(", ") + ", ..."; })
        .on("mouseover", function(d) {
            // SVG element z-index determined by render order, not style sheet
            // so element must be reappended to the end on hover so border 
            // is not occluded
            var parent = $(this).parent();
            $(this).detach().appendTo(parent);
          })
        .on("click", function(d) { window.location = full_explorer_url; })
        .style("fill", function(d) { return color(d.name); });
  
  
    $(".doc rect").tooltip({container:'body', 
                            animation: false, placement: 'top'});
    
    $('#status .bar').addClass('bar-success').css('width', '100%').text("Complete!");
    setTimeout(function() {$('#status').hide()}, 250);
    setTimeout(function() {$('#main').show()}, 250);

}); });


</script>

</body>
</html>
